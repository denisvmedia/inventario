services:
  # PostgreSQL Database (Production)
  postgres:
    image: postgres:17-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-inventario}
      POSTGRES_USER: ${POSTGRES_USER:-inventario}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-inventario_password}
      # Additional PostgreSQL users for migrations (created via init script)
      POSTGRES_MIGRATOR_USER: ${POSTGRES_MIGRATOR_USER:-inventario_migrator}
      POSTGRES_MIGRATOR_PASSWORD: ${POSTGRES_MIGRATOR_PASSWORD:-inventario_migrator_password}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=C --lc-ctype=C"
      # Ensure proper initialization
      PGUSER: ${POSTGRES_USER:-inventario}
    volumes:
      # Persistent PostgreSQL data storage
      - ./.docker/postgresql:/var/lib/postgresql/data
      # Initialization script to create migration user
      - ./init-scripts/01-create-users.sh:/docker-entrypoint-initdb.d/01-create-users.sh:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    networks:
      - inventario-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER:-inventario} -d $${POSTGRES_DB:-inventario}"]
      interval: 3s
      timeout: 5s
      retries: 20
      start_period: 60s

  # Redis (Token Blacklist Cache)
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - ./.docker/redis:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    networks:
      - inventario-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  # Database Bootstrap Service (runs on every startup - idempotent)
  inventario-bootstrap:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    restart: "no"
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Use the main database user for bootstrap
      INVENTARIO_DB_DSN: "postgres://${POSTGRES_USER:-inventario}:${POSTGRES_PASSWORD:-inventario_password}@postgres:5432/${POSTGRES_DB:-inventario}?sslmode=disable"
      INVENTARIO_BOOTSTRAP_USERNAME: "${POSTGRES_USER:-inventario}"
      INVENTARIO_BOOTSTRAP_USERNAME_FOR_MIGRATIONS: "${POSTGRES_MIGRATOR_USER:-inventario_migrator}"
    networks:
      - inventario-network
    volumes:
      - ./scripts/bootstrap.sh:/app/bootstrap.sh:ro
    command: ["sh", "/app/bootstrap.sh"]

  # Database Migration Service (runs on every startup)
  inventario-migrate:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    restart: "no"
    depends_on:
      inventario-bootstrap:
        condition: service_completed_successfully
    environment:
      INVENTARIO_DB_DSN: "postgres://${POSTGRES_MIGRATOR_USER:-inventario_migrator}:${POSTGRES_MIGRATOR_PASSWORD:-inventario_migrator_password}@postgres:5432/${POSTGRES_DB:-inventario}?sslmode=disable"
    networks:
      - inventario-network
    volumes:
      - ./scripts/migrate.sh:/app/migrate.sh:ro
    command: ["sh", "/app/migrate.sh"]

  # Initial Data Setup Service (runs only once using external state tracking)
  inventario-init-data:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    restart: "no"
    depends_on:
      inventario-migrate:
        condition: service_completed_successfully
    environment:
      # Use migrator user for data migration command
      INVENTARIO_DB_DSN: "postgres://${POSTGRES_MIGRATOR_USER:-inventario_migrator}:${POSTGRES_MIGRATOR_PASSWORD:-inventario_migrator_password}@postgres:5432/${POSTGRES_DB:-inventario}?sslmode=disable"
      # Use app user for seeding (has proper role permissions)
      INVENTARIO_SEED_DB_DSN: "postgres://${POSTGRES_USER:-inventario}:${POSTGRES_PASSWORD:-inventario_password}@postgres:5432/${POSTGRES_DB:-inventario}?sslmode=disable"
      # Initial data configuration
      INVENTARIO_MIGRATE_DATA_DEFAULT_TENANT_NAME: ${DEFAULT_TENANT_NAME:-Default Organization}
      INVENTARIO_MIGRATE_DATA_DEFAULT_TENANT_SLUG: ${DEFAULT_TENANT_SLUG:-default}
      INVENTARIO_MIGRATE_DATA_ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@example.com}
      INVENTARIO_MIGRATE_DATA_ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin123}
      INVENTARIO_MIGRATE_DATA_ADMIN_NAME: ${ADMIN_NAME:-System Administrator}
      # Seeding configuration (optional - includes example data and system settings)
      SEED_DATABASE: ${SEED_DATABASE:-true}
      # JWT secret required for seed endpoint
      INVENTARIO_RUN_JWT_SECRET: ${JWT_SECRET:-please-change-this-to-a-secure-random-value-use-openssl-rand-hex-32}
    volumes:
      # Track initialization state to prevent re-running
      - ./.docker/init-state:/app/state
      - ./scripts/init-data.sh:/app/init-data.sh:ro
    networks:
      - inventario-network
    command: ["sh", "/app/init-data.sh"]

  # Inventario Application (Production)
  inventario:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    restart: unless-stopped
    depends_on:
      inventario-init-data:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    environment:
      # Database configuration
      INVENTARIO_DB_DSN: "postgres://${POSTGRES_USER:-inventario}:${POSTGRES_PASSWORD:-inventario_password}@postgres:5432/${POSTGRES_DB:-inventario}?sslmode=disable"

      # Server configuration
      INVENTARIO_ADDR: ":3333"

      # File storage configuration
      INVENTARIO_UPLOAD_LOCATION: "${INVENTARIO_UPLOAD_LOCATION:-file:///app/uploads?create_dir=1}"

      # Security configuration
      INVENTARIO_RUN_JWT_SECRET: ${JWT_SECRET:-please-change-this-to-a-secure-random-value-use-openssl-rand-hex-32}
      INVENTARIO_RUN_FILE_SIGNING_KEY: ${FILE_SIGNING_KEY:-please-change-this-to-a-secure-random-value-use-openssl-rand-hex-32}
      INVENTARIO_RUN_FILE_URL_EXPIRATION: ${FILE_URL_EXPIRATION:-15m}

      # Worker configuration
      INVENTARIO_RUN_MAX_CONCURRENT_EXPORTS: ${MAX_CONCURRENT_EXPORTS:-3}
      INVENTARIO_RUN_MAX_CONCURRENT_IMPORTS: ${MAX_CONCURRENT_IMPORTS:-1}

      # Thumbnail generation configuration
      INVENTARIO_RUN_THUMBNAIL_MAX_CONCURRENT_PER_USER: ${THUMBNAIL_MAX_CONCURRENT_PER_USER:-5}
      INVENTARIO_RUN_THUMBNAIL_RATE_LIMIT_PER_MINUTE: ${THUMBNAIL_RATE_LIMIT_PER_MINUTE:-50}
      INVENTARIO_RUN_THUMBNAIL_SLOT_DURATION: ${THUMBNAIL_SLOT_DURATION:-30m}

      # Token blacklist configuration
      INVENTARIO_RUN_TOKEN_BLACKLIST_REDIS_URL: "${TOKEN_BLACKLIST_REDIS_URL:-redis://redis:6379}"

      # System configuration
      TZ: ${TZ:-UTC}
    volumes:
      # Persistent storage for uploads and data
      - ./.docker/inventario/uploads:/app/uploads
    ports:
      - "${INVENTARIO_PORT:-3333}:3333"
    networks:
      - inventario-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3333/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # PostgreSQL Test Database
  postgres-test:
    profiles: ["test"]
    image: postgres:17-alpine
    environment:
      POSTGRES_DB: ${POSTGRES_TEST_DB:-inventario_test}
      POSTGRES_USER: ${POSTGRES_TEST_USER:-inventario_test}
      POSTGRES_PASSWORD: ${POSTGRES_TEST_PASSWORD:-test_password}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=C --lc-ctype=C"
    ports:
      - "${POSTGRES_TEST_PORT:-5433}:5432"  # Use different port to avoid conflicts
    networks:
      - inventario-test-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_TEST_USER:-inventario_test} -d ${POSTGRES_TEST_DB:-inventario_test}"]
      interval: 5s
      timeout: 3s
      retries: 10
    # Use tmpfs for faster tests and no persistence
    tmpfs:
      - /var/lib/postgresql/data
    # Automatically remove container after stopping
    restart: "no"
    # PostgreSQL configuration for testing
    command: >
      postgres
      -c max_connections=200
      -c shared_buffers=64MB
      -c effective_cache_size=128MB
      -c maintenance_work_mem=32MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=8MB
      -c default_statistics_target=50
      -c random_page_cost=1.1
      -c effective_io_concurrency=100
      -c work_mem=2MB
      -c min_wal_size=512MB
      -c max_wal_size=1GB
      -c max_worker_processes=4
      -c max_parallel_workers_per_gather=1
      -c max_parallel_workers=4
      -c max_parallel_maintenance_workers=1

  # Database Migration Service (Test)
  inventario-test-migrate:
    profiles: ["test"]
    build:
      context: .
      dockerfile: Dockerfile
      target: test-runner
    depends_on:
      postgres-test:
        condition: service_healthy
    environment:
      # PostgreSQL test configuration
      POSTGRES_TEST_DSN: "postgres://${POSTGRES_TEST_USER:-inventario_test}:${POSTGRES_TEST_PASSWORD:-test_password}@postgres-test:5432/${POSTGRES_TEST_DB:-inventario_test}?sslmode=disable&pool_max_conns=5&pool_min_conns=1"
    networks:
      - inventario-test-network
    volumes:
      # Mount source code for development testing
      - ./go:/app/go:ro
    working_dir: /app/go
    # Run migrations
    command: ["go", "run", ".", "migrate", "--db-dsn=postgres://${POSTGRES_TEST_USER:-inventario_test}:${POSTGRES_TEST_PASSWORD:-test_password}@postgres-test:5432/${POSTGRES_TEST_DB:-inventario_test}?sslmode=disable&pool_max_conns=5&pool_min_conns=1"]
    # Automatically remove container after stopping
    restart: "no"

  # Inventario Test Runner
  inventario-test:
    profiles: ["test"]
    build:
      context: .
      dockerfile: Dockerfile
      target: test-runner
    depends_on:
      postgres-test:
        condition: service_healthy
      inventario-test-migrate:
        condition: service_completed_successfully
    environment:
      # PostgreSQL test configuration
      POSTGRES_TEST_DSN: "postgres://${POSTGRES_TEST_USER:-inventario_test}:${POSTGRES_TEST_PASSWORD:-test_password}@postgres-test:5432/${POSTGRES_TEST_DB:-inventario_test}?sslmode=disable&pool_max_conns=5&pool_min_conns=1"

      # Test configuration
      GO_TEST_TIMEOUT: "${GO_TEST_TIMEOUT:-10m}"
      GO_TEST_VERBOSE: "${GO_TEST_VERBOSE:-true}"

      # Application configuration for tests
      INVENTARIO_DB_DSN: "postgres://${POSTGRES_TEST_USER:-inventario_test}:${POSTGRES_TEST_PASSWORD:-test_password}@postgres-test:5432/${POSTGRES_TEST_DB:-inventario_test}?sslmode=disable&pool_max_conns=1&pool_min_conns=1"
      INVENTARIO_ADDR: ":3333"
      INVENTARIO_UPLOAD_LOCATION: "file:///tmp/test-uploads?create_dir=1"

      # Test environment
      TZ: UTC
    networks:
      - inventario-test-network
    volumes:
      # Mount source code for development testing
      - ./go:/app/go:ro
      - ./frontend:/app/frontend:ro
      # Temporary upload location
      - /tmp/test-uploads
    working_dir: /app/go
    # Default command runs all tests
    command: ["go", "test", "-v", "-timeout", "${GO_TEST_TIMEOUT:-10m}", "./..."]
    # Automatically remove container after stopping
    restart: "no"

  inventario-test-migration:
    profiles: ["test"]
    build:
      context: .
      dockerfile: Dockerfile
      target: test-runner
    depends_on:
      postgres-test:
        condition: service_healthy
    environment:
      # PostgreSQL test configuration
      POSTGRES_TEST_DSN: "postgres://${POSTGRES_TEST_USER:-inventario_test}:${POSTGRES_TEST_PASSWORD:-test_password}@postgres-test:5432/${POSTGRES_TEST_DB:-inventario_test}?sslmode=disable&pool_max_conns=5&pool_min_conns=1"

      # Test configuration
      GO_TEST_TIMEOUT: "${GO_TEST_TIMEOUT:-10m}"
      GO_TEST_VERBOSE: "${GO_TEST_VERBOSE:-true}"

      # Application configuration for tests
      INVENTARIO_DB_DSN: "postgres://${POSTGRES_TEST_USER:-inventario_test}:${POSTGRES_TEST_PASSWORD:-test_password}@postgres-test:5432/${POSTGRES_TEST_DB:-inventario_test}?sslmode=disable&pool_max_conns=1&pool_min_conns=1"
      INVENTARIO_ADDR: ":3333"
      INVENTARIO_UPLOAD_LOCATION: "file:///tmp/test-uploads?create_dir=1"
      INVENTARIO_OPERATIONAL_USER: "${POSTGRES_TEST_USER:-inventario_test}"

      # Test environment
      TZ: UTC
    networks:
      - inventario-test-network
    volumes:
      # Mount source code for development testing
      - ./go:/app/go:ro
      - ./go/registry/ptah/migrations/source:/app/go/registry/ptah/migrations/source:rw
      # Temporary upload location
      - /tmp/test-uploads
    working_dir: /app/go
    # Default command runs all tests
    command:
      - sh
      - -c
      - |
        echo "Building application..."
        go build -o /app/inventario
        echo "Running migrations..."
        /app/inventario migrate up
        echo "Generating schema updates..."
        /app/inventario migrate generate
        echo "Count migrations..."
        count=$$(ls -1 /app/go/registry/ptah/migrations/source/*.up.sql | wc -l)
        echo "Re-building application..."
        go build -o /app/inventario
        echo "Running updated migrations..."
        /app/inventario migrate up
        echo "Verifying migrations are up to date..."
        /app/inventario migrate status
        echo "Verify no additional migrations are needed..."
        /app/inventario migrate generate
        echo "Count migrations again..."
        count2=$$(ls -1 /app/go/registry/ptah/migrations/source/*.up.sql | wc -l)
        if [ "$$count" -ne "$$count2" ]; then
          echo "Additional migrations generated. Please review."
          exit 1
        fi
        # echo color green
        echo "\033[0;32mAdditional migrations are not needed. Schema is up to date.\033[0m"
    # Automatically remove container after stopping
    restart: "no"

  # Inventario PostgreSQL-only Test Runner
  inventario-test-postgres:
    profiles: ["test"]
    build:
      context: .
      dockerfile: Dockerfile
      target: test-runner
    depends_on:
      postgres-test:
        condition: service_healthy
      inventario-test-migrate:
        condition: service_completed_successfully
    environment:
      # PostgreSQL test configuration
      POSTGRES_TEST_DSN: "postgres://${POSTGRES_TEST_USER:-inventario_test}:${POSTGRES_TEST_PASSWORD:-test_password}@postgres-test:5432/${POSTGRES_TEST_DB:-inventario_test}?sslmode=disable&pool_max_conns=1&pool_min_conns=1"

      # Test configuration
      GO_TEST_TIMEOUT: "${GO_TEST_TIMEOUT:-10m}"
      GO_TEST_VERBOSE: "${GO_TEST_VERBOSE:-true}"

      # Test environment
      TZ: UTC
    networks:
      - inventario-test-network
    volumes:
      # Mount source code for development testing
      - ./go:/app/go:ro
    working_dir: /app/go
    # Command runs only PostgreSQL tests (sequential to avoid connection issues)
    command: ["go", "test", "-v", "-timeout", "${GO_TEST_TIMEOUT:-10m}", "-p", "1", "./registry/postgres/..."]
    # Automatically remove container after stopping
    restart: "no"

networks:
  # Production network
  inventario-network:
    driver: bridge

  # Test network
  inventario-test-network:
    driver: bridge

volumes:
  # Named volumes for easier management (optional, using bind mounts above)
  postgres-data:
  inventario-uploads:
  inventario-data:
  redis-data:

  # Test volumes (optional, using tmpfs above)
  postgres-test-data:

--- settings_test.go
+++ settings_test.go
@@ -10,9 +10,11 @@ import (
 
 qt "github.com/frankban/quicktest"
 "github.com/go-chi/chi/v5"
+"github.com/shopspring/decimal"
 
 "github.com/denisvmedia/inventario/apiserver"
 "github.com/denisvmedia/inventario/appctx"
+"github.com/denisvmedia/inventario/internal/currency"
 "github.com/denisvmedia/inventario/models"
 "github.com/denisvmedia/inventario/registry/memory"
 )
@@ -24,10 +26,19 @@ func TestSettingsAPI(t *testing.T) {
 factorySet := memory.NewFactorySet()
 c.Assert(factorySet, qt.IsNotNil)
 
+// Create a conversion service for testing
+rateProvider := currency.NewStaticRateProvider(map[string]decimal.Decimal{
+"USD_EUR": decimal.NewFromFloat(0.85),
+"EUR_USD": decimal.NewFromFloat(1.18),
+"EUR_GBP": decimal.NewFromFloat(0.86),
+"GBP_EUR": decimal.NewFromFloat(1.16),
+})
+conversionService := currency.NewConversionService(nil, rateProvider)
+
 // Create a router with the settings endpoint and registry middleware
 r := chi.NewRouter()
 r.Use(apiserver.RegistrySetMiddleware(factorySet))
-r.Route("/settings", apiserver.Settings())
+r.Route("/settings", apiserver.Settings(conversionService))
 
 // Test GET /settings (empty settings)
 req := httptest.NewRequest("GET", "/settings", nil)
@@ -35,6 +46,7 @@ func TestSettingsAPI(t *testing.T) {
 TenantAwareEntityID: models.TenantAwareEntityID{
 TenantID: "test-tenant-id",
 EntityID: models.EntityID{ID: "test-user-id"},
 },
+IsActive: true,
 }))
 w := httptest.NewRecorder()
--- /dev/null
+++ /dev/null
@@ -63,6 +75,7 @@ func TestSettingsAPI(t *testing.T) {
 TenantAwareEntityID: models.TenantAwareEntityID{
 TenantID: "test-tenant-id",
 EntityID: models.EntityID{ID: "test-user-id"},
 },
+IsActive: true,
 }))
 w = httptest.NewRecorder()
--- /dev/null
+++ /dev/null
@@ -82,6 +95,7 @@ func TestSettingsAPI(t *testing.T) {
 TenantAwareEntityID: models.TenantAwareEntityID{
 TenantID: "test-tenant-id",
 EntityID: models.EntityID{ID: "test-user-id"},
 },
+IsActive: true,
 }))
 w = httptest.NewRecorder()
--- /dev/null
+++ /dev/null
@@ -105,6 +119,7 @@ func TestSettingsAPI(t *testing.T) {
 TenantAwareEntityID: models.TenantAwareEntityID{
 TenantID: "test-tenant-id",
 EntityID: models.EntityID{ID: "test-user-id"},
 },
+IsActive: true,
 }))
 w = httptest.NewRecorder()
--- /dev/null
+++ /dev/null
@@ -125,6 +140,7 @@ func TestSettingsAPI(t *testing.T) {
 TenantAwareEntityID: models.TenantAwareEntityID{
 TenantID: "test-tenant-id",
 EntityID: models.EntityID{ID: "test-user-id"},
 },
+IsActive: true,
 }))
 w = httptest.NewRecorder()
--- /dev/null
+++ /dev/null
@@ -140,22 +156,31 @@ func TestSettingsAPI(t *testing.T) {
 c.Assert(*finalSettings.ShowDebugInfo, qt.Equals, showDebugInfo)
 }
 
-func TestMainCurrencyRestriction(t *testing.T) {
+func TestMainCurrencyCanBeChanged(t *testing.T) {
 c := qt.New(t)
 
 // Create a memory factory set for testing
 factorySet := memory.NewFactorySet()
 c.Assert(factorySet, qt.IsNotNil)
 
+// Create a conversion service for testing
+rateProvider := currency.NewStaticRateProvider(map[string]decimal.Decimal{
+"USD_EUR": decimal.NewFromFloat(0.85),
+"EUR_USD": decimal.NewFromFloat(1.18),
+"EUR_GBP": decimal.NewFromFloat(0.86),
+"GBP_EUR": decimal.NewFromFloat(1.16),
+})
+conversionService := currency.NewConversionService(nil, rateProvider)
+
 // Create a router with the settings endpoint and registry middleware
 r := chi.NewRouter()
 r.Use(apiserver.RegistrySetMiddleware(factorySet))
-r.Route("/settings", apiserver.Settings())
+r.Route("/settings", apiserver.Settings(conversionService))
 
 // First, set the main currency to USD
-currency := "USD"
+mainCurrency := "USD"
 testSettings := models.SettingsObject{
-MainCurrency: &currency,
+MainCurrency: &mainCurrency,
 }
 settingsJSON, err := json.Marshal(testSettings)
 c.Assert(err, qt.IsNil)
@@ -165,6 +190,7 @@ func TestMainCurrencyRestriction(t *testing.T) {
 TenantAwareEntityID: models.TenantAwareEntityID{
 TenantID: "test-tenant-id",
 EntityID: models.EntityID{ID: "test-user-id"},
 },
+IsActive: true,
 }))
 w := httptest.NewRecorder()
--- /dev/null
+++ /dev/null
@@ -181,36 +207,44 @@ func TestMainCurrencyRestriction(t *testing.T) {
 TenantAwareEntityID: models.TenantAwareEntityID{
 TenantID: "test-tenant-id",
 EntityID: models.EntityID{ID: "test-user-id"},
 },
+IsActive: true,
 }))
 w = httptest.NewRecorder()
 r.ServeHTTP(w, req)
 
-// Should get an error
-c.Assert(w.Code, qt.Equals, http.StatusUnprocessableEntity)
+// Should succeed now
+c.Assert(w.Code, qt.Equals, http.StatusOK)
 
-// Try to change the main currency to EUR using PATCH
-currencyJSON, err := json.Marshal(newCurrency)
+// Try to change the main currency to GBP using PATCH
+finalCurrency := "GBP"
+currencyJSON, err := json.Marshal(finalCurrency)
 c.Assert(err, qt.IsNil)
 
 req = httptest.NewRequest("PATCH", "/settings/system.main_currency", bytes.NewReader(currencyJSON))
 req = req.WithContext(appctx.WithUser(context.Background(), &models.User{
 TenantAwareEntityID: models.TenantAwareEntityID{
 TenantID: "test-tenant-id",
 EntityID: models.EntityID{ID: "test-user-id"},
 },
+IsActive: true,
 }))
 w = httptest.NewRecorder()
 r.ServeHTTP(w, req)
 
-// Should get an error
-c.Assert(w.Code, qt.Equals, http.StatusUnprocessableEntity)
+// Should succeed now
+if w.Code != http.StatusOK {
+c.Logf("Response body: %s", w.Body.String())
+c.Logf("Response code: %d", w.Code)
+}
+c.Assert(w.Code, qt.Equals, http.StatusOK)
 
-// Verify the main currency is still USD
+// Verify the main currency is now GBP
 req = httptest.NewRequest("GET", "/settings", nil)
 req = req.WithContext(appctx.WithUser(context.Background(), &models.User{
 TenantAwareEntityID: models.TenantAwareEntityID{
 TenantID: "test-tenant-id",
 EntityID: models.EntityID{ID: "test-user-id"},
 },
+IsActive: true,
 }))
--- /dev/null
+++ /dev/null
@@ -220,5 +254,5 @@ func TestMainCurrencyRestriction(t *testing.T) {
 var retrievedSettings models.SettingsObject
 err = json.Unmarshal(w.Body.Bytes(), &retrievedSettings)
 c.Assert(err, qt.IsNil)
-c.Assert(*retrievedSettings.MainCurrency, qt.Equals, currency) // Should still be USD
+c.Assert(*retrievedSettings.MainCurrency, qt.Equals, finalCurrency) // Should be GBP
 }

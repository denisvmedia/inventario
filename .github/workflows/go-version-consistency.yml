name: Go Version Consistency

on:
  push:
    branches:
      - master
  pull_request:

permissions:
  contents: read

jobs:
  check-go-version:
    name: Check Go Version Consistency
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract Go version from go.mod
        id: go_mod_version
        run: |
          GO_MOD_VERSION=$(grep '^go ' go.mod | awk '{print $2}')
          echo "GO_MOD_VERSION=$GO_MOD_VERSION" >> $GITHUB_OUTPUT

      - name: Check go-version in workflows
        run: |
          set -e
          GO_MOD_VERSION="${{ steps.go_mod_version.outputs.GO_MOD_VERSION }}"
          echo "Go version in go.mod: $GO_MOD_VERSION"
          for wf in .github/workflows/*.yml; do
            WF_VERSION=$(grep -A 2 'setup-go@' "$wf" | grep 'go-version:' | head -1 | awk -F\' '{print $2}' | awk -F'"' '{print $2}' | awk '{print $2}')
            if [ -z "$WF_VERSION" ]; then
              # Try with double quotes or colon
              WF_VERSION=$(grep -A 2 'setup-go@' "$wf" | grep 'go-version:' | head -1 | awk -F: '{print $2}' | tr -d "'\" ")
            fi
            if [ -n "$WF_VERSION" ]; then
              echo "$wf: go-version $WF_VERSION"
              if [ "$WF_VERSION" != "$GO_MOD_VERSION" ]; then
                echo "::error file=$wf::go-version ($WF_VERSION) does not match go.mod ($GO_MOD_VERSION)" >&2
                exit 1
              fi
            fi
          done
        shell: bash

